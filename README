Based on gist #998096 (https://gist.github.com/998096)
